#!/bin/bash

REPO_NAME=${1:-$(basename "$(pwd)")}
USERNAME=$(gh api user --jq .login 2>/dev/null)
CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD 2>/dev/null || echo "main")

echo "ğŸ’¦ PUSHING HARD (PRIVATE + BRANCH-AWARE) into GitHub as $USERNAME, repo: $REPO_NAME"
echo "ğŸŒ¿ Current branch: $CURRENT_BRANCH"

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Branding prompt
read -p "ğŸŒŸ Do you want to include the sexy PushHardâ„¢ README branding? (y/N): " INCLUDE_BRANDING
INCLUDE_BRANDING=$(echo "$INCLUDE_BRANDING" | tr '[:upper:]' '[:lower:]')

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ README
if [[ "$INCLUDE_BRANDING" == "y" || "$INCLUDE_BRANDING" == "yes" ]]; then
cat <<EOL > README.md
# ğŸš€ $REPO_NAME

> Built with sweat, swagger, and a whole lotta PushHardâ„¢ ğŸ’¦
> _(Auto-generated by \`pushhard.sh\`)_

---

## ğŸ”¥ What Is This?
Legendary repo. Precision, speed, zero tolerance for git fuckery.

---

## ğŸ§  Features
- ğŸ”’ Private by default
- ğŸ§¼ Auto-untracks garbage (.env, node_modules)
- ğŸ™ Instantly deploys to GitHub
- ğŸ” Handles diverged branches like a Git therapist
- ğŸ’¥ README, .gitignore, first commit: **done**
EOL
else
  echo "# $REPO_NAME" > README.md
fi
touch README.md            # ensure mtime updated

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ .gitignore
cat <<EOL > .gitignore
.env
.env.local
node_modules/
.DS_Store
dist/
.next/
out/
build/
coverage/
*.log
*.sqlite
EOL

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Clean tracked trash
git rm -r --cached node_modules/ dist/ .next/ out/ build/ coverage/ .env .env.local .DS_Store 2>/dev/null

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Init repo if absent
if [ ! -d .git ]; then
  echo "ğŸ§¬ No Git found â€” initializingâ€¦"
  git init
  git checkout -b "$CURRENT_BRANCH"
  git add .
  git commit -m "ğŸ’¥ pushhard: first commit, repo cleansed"
else
  echo "ğŸ“¦ Git repo already exists. Continuingâ€¦"
fi

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Create repo if no origin
if ! git remote | grep -q origin; then
  echo "ğŸ”’ Creating PRIVATE GitHub repo via gh CLIâ€¦"
  gh repo create "$REPO_NAME" --private --source=. --remote=origin --push
else
  echo "ğŸ” Remote already exists. Checking for updatesâ€¦"

  # â”€â”€â”€â”€â”€ Ensure origin URL belongs to current user
  REMOTE_URL=$(git remote get-url origin 2>/dev/null)
  if [[ "$REMOTE_URL" != *"$USERNAME"* ]]; then
    echo "âš ï¸  origin is $REMOTE_URL â€” repointing to git@github.com:$USERNAME/$REPO_NAME.git"
    git remote set-url origin git@github.com:$USERNAME/$REPO_NAME.git
  fi

  git fetch origin "$CURRENT_BRANCH" 2>/dev/null
  STATUS=$(git status -sb)

  if [[ $STATUS == *"ahead"* && $STATUS == *"behind"* ]]; then
    echo "âŒ Branch has diverged. Manual fix needed. PushHard aborted."
    exit 1
  elif [[ $STATUS == *"behind"* ]]; then
    echo "ğŸ“¥ Behind remote. Pulling updatesâ€¦"
    git pull origin "$CURRENT_BRANCH" --rebase
  fi

  echo "ğŸ” Git status before commit:"
  git status

  # â”€â”€â”€â”€â”€ Stage everything
  git add -A

  if ! git diff --cached --quiet; then
    echo "ğŸ“¦ Committing updatesâ€¦"
    git commit -m "ğŸ” pushhard: update"
    git push origin "$CURRENT_BRANCH"
  else
    echo "ğŸŸ¢ Nothing new to commit. Checking README just in caseâ€¦"
    git add README.md
    if ! git diff --cached --quiet; then
      echo "ğŸ“„ README.md was updated â€” committing forcefully."
      git commit -m "ğŸ“ pushhard: forced README update"
      git push origin "$CURRENT_BRANCH"
    else
      echo "âœ”ï¸  Confirmed: no detectable changes. Repo fully synced."
    fi
  fi
fi

echo "âœ… Private repo is live at: https://github.com/$USERNAME/$REPO_NAME/tree/$CURRENT_BRANCH"
echo "ğŸ”’ PushHard complete. GitHub respected. Swagger intact."
